How to calculate lake inflow using output from WATFLOOD or standalone MESH

Step 1:
The first step to calculate the lake inflow is to create the input file "glake_inflow.csv".

This is a three column file with the identifier of the lake in the first column and then the east-west coordinate of the grid in column 2 and the north-south coordinate in column 3.  

The program lake_inflow_streamflow_files.f90 will create the glake_inflow.csv file from the basin's *.map file (although this program was obviously designed for the Great Lakes it should work for any watershed).  For each of the values found in the "reach number" section of the *.map file, the program will determine the grids that flow into that reach.

Step 2:
The second step is to run either WATFLOOD or Standalone MESH to get a file containing gridded outflow (which is actually streamflow) for each day of the run.


For WATFLOOD:

- run WATFLOOD (or WATFLOOD in WATROUTE mode) with the ensim flag to "y" for all events

- make sure that WFO_SPEC.txt file only outputs (ie. has a 1) for  "Grid Outflow"

- this will create a watflood.wfo file in the results directory

- create a new file called watflood_mod.wfo by deleting the ascii header information (couldn't get the program to skip over it).

- now proceed to step 3


For Standalone MESH:

- had to add the following to the standalone MESH code:

Near the top:

OPEN(unit=72,file="./" // GENDIR_OUT(1:INDEX(GENDIR_OUT," ")-1) // &
                  '/basin_streamflow_hourly.csv')


After the call to WF_ROUTE:

! Write out streamflow for each grid point
  DO K = 1, ycount
    DO J = 1, xcount
      WF_QSYN_GRID(J,K)= -1.00
    END DO
  END DO

  DO I = 1, NA
     WF_QSYN_GRID(YYY(I),XXX(I))=WF_QSYN(I)
  END DO

  DO K = ycount, 1 , -1
     WRITE( 72, '(F10.3, 999(",", F10.3) )' ) (WF_QSYN_GRID(K,J),J=1, xcount)
  END DO
  WRITE( 72, * )

And where all the files are closed at the end just to keep it neat:

CLOSE(UNIT=72)


- run standalone MESH

- now proceed to step 3


Step 3:
The program Calculate_lake_inflow.f90 will take output from both the WATFLOOD and Standalone MESH model and outputs a file you can use to calculate the amount of inflow into a lake.  

It uses a file containing grided outflow (which is actually streamflow) created by each model and creates a *.csv file for a series of grids.  If these grids are the ones that inflow into a lake then you can sum the columns together in the *.csv file and that will be the inflow into the lake.  This is the way the program was set up, but of course you can have whichever grids you wanted in the input file.

There is a hardcoded WATFLOOD flag in the program, if you are using WATFLOOD output it is true and if you are using standalone MESH it is false.

For WATFLOOD it uses watflood_mod.wfo as the input, for standalone MESH is uses basin_streamflow_daily.csv.


After running "Calcualte_lake_inflow.f90", 2 files will be created - inflow_daily.csv and inflow_monthly.csv

This file has a column for each of the inflows, for each column the first row is the number from the the glake_inflow.csv file.  Then the next row is the east-west coordinate of the grid in the third row is the north-south coordinate.  After that are the daily or monthly flow for that grid.

Then you can create a spreadsheet like the example Lake_inflow07.xlsx (should be in this directory) that will sum all the correct columns to get the correct total inflow into each lake.  It is important not to include the inflow into the lake from the one above as we are generally interested only in the inflow into the lake from the land.

The spreadsheet example I have also converts between cms and mm for each of the different lakes.
